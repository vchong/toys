#!/bin/sh

#
# sse-auto-report
#
# (Almost) fully automatic monthly report generator
#

#
# General prep
#

day=`date +'%-d'`
since=`date -d"last-month -$(($day - 1)) days 00:00:00" +"%Y-%m-%d %H:%M:%S"`
until=`date -d"-$day days 23:59:59" +"%Y-%m-%d %H:%M:%S"`
full_year_since=`date -d"-$(($day - 1)) days -1 year 00:00:00" +"%Y-%m-%d %H:%M:%S"`

echo "Generating report from $since until $until"
echo

if [ -z $SSE_DATA_DIR ]
then
	SSE_DATA_DIR=reports/`date -d "$until" +"%Y-%m"`
fi

mkdir -p $SSE_DATA_DIR/tmp
cd $SSE_DATA_DIR

#
# Generate the monthly report template and the "solutions" graphs
#

printf "Generating solutions engineering report ..."
[ -e tmp/monthly.html ] || \
    glimpse monthly --fully-automatic --since "$since" --until "$until" > tmp/monthly.html 2> tmp/monthly.errlog
sed -i -e '/^<\/*html>$/d' -e '/^<\/*head>$/d' -e '/^<title>/d' -e '/^<\/*body>/d' tmp/monthly.html
printf " done\nGenerating solutions engineering graphs ..."
[ -e tmp/piechart.errlog ] || \
    glimpse piechart --since "$since" --until "$until" 2> tmp/piechart.errlog
printf " done\n"

#
# Grab LDTS data for this month
#

printf "Grabbing LDTS monthly activity ..."
[ -e tmp/ldtstool-pull.errlog ] || \
    ldtstool pull 2> tmp/ldtstool-pull.errlog
printf " done\n"

printf "Generating LDTS activity graphs ."

ldtstool dump | ldtstool filter --restrict created --member \
		--since "$full_year_since" --until "$until" | \
ldtstool chart --output "ldts-by_month_by_member.png"
printf "."

ldtstool dump | ldtstool filter --restrict created --member \
		--since "$since" --until "$until" | \
ldtstool piechart --by-member --output "ldts-by_member.png"
printf "."

ldtstool dump | ldtstool filter --restrict created --member \
		--since "$full_year_since" --until "$until" | \
ldtstool piechart --by-member --output "ldts-by_member-full_year.png"
printf "."

ldtstool dump | ldtstool filter --restrict created --member \
		--since "$full_year_since" --until "$until" | \
ldtstool chart --by-category --output "ldts-by_month_by_category.png"
printf "."

ldtstool dump | ldtstool filter --restrict created --member \
		--since "$since" --until "$until" | \
ldtstool piechart --by-category --output "ldts-by_category.png"
printf "."

ldtstool dump | ldtstool filter --restrict created --member \
		--since "$full_year_since" --until "$until" | \
	ldtstool piechart --by-category --output "ldts-by_category-full_year.png"
printf "."

ldtstool dump | ldtstool filter --restrict created --community \
		--since "$full_year_since" --until "$until" | \
ldtstool chart --by-category --output "community-by_month_by_category.png"
printf "."

printf " done\n"

printf "Generating LDTS activity report ..."
ldtstool dump | ldtstool filter --since "$since" --until "$until" | \
	ldtstool monthly > tmp/ldts.html
printf " done\n"

#
# Slurp up posts by the team on the forum
#

for i in danielt ldts ldts-atsuka leo-yan vchong
do
	printf "Grabbing 96Boards data for $i ."
	[ -e tmp/96b-$i.json ] || \
	    96btool fetch --nick $i --since "$full_year_since" --show-progress > tmp/96b-$i.json
	printf " %d posts\n" `cat tmp/96b-$i.json | 96btool filter --since "$since" --until "$until" | 96btool count`
done

printf "Generating 96boards activity report ..."
cat tmp/96b-*.json | 96btool merge | 96btool filter --until "$until" > tmp/96boards.json
cat tmp/96boards.json | 96btool filter --since "$since" | 96btool monthly > tmp/96boards.html
printf " done\n"

printf "Generating 96boards activity graphs ..."
cat tmp/96boards.json | 96btool chart --output 96b_by_month.png
cat tmp/96boards.json | 96btool piechart --output 96b_pie_of_the_year.png
cat tmp/96boards.json | 96btool filter --since "$since" | 96btool piechart --output 96b_pie_of_the_month.png
printf " done\n"

#
# Bring everything together as a HTML document
#

printf "\nGenerating report ..."

cat > monthly_report.html <<EOF
<html>
<head>
<title>LSSE `date -d "$until" +"%Y.%m"` Monthly Report</title>
</head>
<body>
<h1>LSSE `date -d "$until" +"%Y.%m"` Monthly Report</h1>

<p>This report is 100% auto-generated and does not have an executive summary</p>

<h1>Activity Breakdown</h1>

<h2>Solutions Engineering</h2>

<p><table>
  <tr><td><img src="card_tracker.png"></td></tr>
  <tr><td><strong>Figure 1.1</strong>: Summary of cards created and completed over the last 12 months.</td></tr>
</table></p>

<p><table>
  <tr>
     <td><img src="cards_per_member.png" width="400" height="300"></td>
     <td><img src="cards_per_member-full_year.png" width="400" height="300"></td>
  </tr>
  <tr>
     <td><strong>Figure 1.2</strong>: Cards worked on this month</td>
     <td><strong>Figure 1.3</strong>: Cards worked on over the last 12 months.</td>
  </tr>
</table></p>

<p>Figure 1.1 shows the new issues vs completed issues tackled by the SSE
team during the previous months. Each card represents a unit of work
that is visible to a member. Figures 1.2 and 1.3 show the cards that
have been worked on this month which members the work was for. None of
the above graphs indicate the level of effort invested by the team,
instead they should represent units of work that the member is aware
of us completing.</p>

<p><table>
  <tr><td><img src="effort_by_month_and_member.png"></td></tr>
  <tr><td><strong>Figure 1.4</strong>: Effort summary organised by month and by member</td></tr>
</table></p>

<p><table>
  <tr>
     <td><img src="effort_per_member.png" width="400" height="300"></td>
     <td><img src="effort_per_member-full_year.png" width="400" height="300">
  </tr>
  <tr>
     <td><strong>Figure 1.5</strong>: Effort for each member this month</td>
     <td><strong>Figure 1.6</strong>: Effort for each member over the last 12 months</td>
  </tr>
</table></p>

<p>Figure 1.4 describes the effort applied by the team towards Solutions
Engineering (formerly known as Premium Services). It does not include
effort towards LDTS, 96Boards forum or team management and, for this
reason, total effort is not expected to track headcount within the
team. Figure 1.5 zooms in on the final column of the bar chart and
offers a more detailed breakdown whilst figure 1.6 provides a full-year
breakdown as a contrast.</p>

<p><table>
  <tr><td><img src="effort_by_month_and_category.png"></td></tr>
  <tr><td><strong>Figure 1.7</strong>: Effort summary organised by month and by category</td></tr>
</table></p>

<p><table>
  <tr>
     <td><img src="effort_by_category.png" width="400" height="300"></td>
     <td><img src="effort_by_category-full_year.png" width="400" height="300">
  </tr>
  <tr>
     <td><strong>Figure 1.8</strong>: Effort this month, by category</td>
     <td><strong>Figure 1.9</strong>: Effort over last 12 months, by category</td>
  </tr>
</table></p>

<p>The chart above show the effort expended this month and contrast it
with the effort over the last 12 months.</p>

<h2>Support via LDTS</h2>

<p><table>
<tr><td><img src="ldts-by_month_by_member.png"></td></tr>
  <tr><td><strong>Figure 2.1</strong>: Member tickets, organised by month and by member</td></tr>
</table></p>

<p><table>
  <tr>
     <td><img src="ldts-by_member.png" width="400" height="300"></td>
     <td><img src="ldts-by_member-full_year.png" width="400" height="300"></td>
  </tr>
  <tr>
     <td><strong>Figure 2.2</strong>: Activity this month, by member</td>
     <td><strong>Figure 2.3</strong>: Activity this year, by member</td>
  </tr>
</table></p>

<p>For LDTS there is no effort tracking so we can only monitor ticket
volumes. The graph above shows the breakdown, by member, of tickets
this month.
(Zendesk makes it difficult, but not impossible, to automate).</p>

<p><table>
<tr><td><img src="ldts-by_month_by_category.png"></td></tr>
  <tr><td><strong>Figure 2.4</strong>: Member tickets, organised by month and by category</td></tr>
</table></p>

<p><table>
<p><table>
  <tr>
     <td><img src="ldts-by_category.png" width="400" height="300"></td>
     <td><img src="ldts-by_category-full_year.png" width="400" height="300"></td>
  </tr>
  <tr>
     <td><strong>Figure 2.5</strong>: Activity this month, by category</td>
     <td><strong>Figure 2.6</strong>: Activity this year, by category</td>
  </tr>
</table></p>

<p><table>
<tr><td><img src="community-by_month_by_category.png"></td></tr>
  <tr><td><strong>Figure 2.7</strong>: Community tickets, organised by month and by category</td></tr>
</table></p>

<p><table>
<h2>96Boards Support</h2>

<p><table>
  <tr><td><img src="96b_by_month.png"></td></tr>
  <tr><td><strong>Figure 3.1</strong>: Posts by month and topic.</td></tr>
</table></p>

<p>Figure 3.1 shows the post volumes by SSE team members for the last year.
This report does not include general details of forum health; no automated
tools exist to gather this information and it has a scope beyond that
of the SSE team.</p>

<p><table>
  <tr>
     <td><img src="96b_pie_of_the_month.png" width="400" height="300"></td>
     <td><img src="96b_pie_of_the_year.png" width="400" height="300"></td>
  </tr>
  <tr>
     <td><strong>Figure 3.2</strong>: Posts this month, by topic.</td>
     <td><strong>Figure 3.3</strong>: Posts this year, by topic.</td>
  </tr>
</table></p>

<h1>Detailed activity report</h1>

<h2>Solutions Engineering</h2>

`cat tmp/monthly.html`

<h2>Support via LDTS</h2>

`cat tmp/ldts.html`

<h2>96Boards Support</h2>

`cat tmp/96boards.html`

</body>
</html>
EOF

printf " $SSE_DATA_DIR/monthly_report.html\n"
